var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};
$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Object.fromEntries",function(a){return a?a:function(a){var b={};$jscomp.initSymbolIterator();if(!(Symbol.iterator in a))throw new TypeError(""+a+" is not iterable");a=a[Symbol.iterator].call(a);for(var d=a.next();!d.done;d=a.next()){d=d.value;if(Object(d)!==d)throw new TypeError("iterable for fromEntries should yield objects");b[d[0]]=d[1]}return b}},"es_2019","es3");$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
$jscomp.polyfill("Object.entries",function(a){return a?a:function(a){var b=[],d;for(d in a)$jscomp.owns(a,d)&&b.push([d,a[d]]);return b}},"es8","es3");$jscomp.polyfill("Math.sign",function(a){return a?a:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6","es3");
$jscomp.polyfill("Array.prototype.flat",function(a){return a?a:function(a){a=void 0===a?1:a;for(var b=[],d=0;d<this.length;d++){var e=this[d];Array.isArray(e)&&0<a?(e=Array.prototype.flat.call(e,a-1),b.push.apply(b,e)):b.push(e)}return b}},"es9","es5");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};
$jscomp.polyfill("String.prototype.endsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"endsWith");a+="";void 0===c&&(c=b.length);c=Math.max(0,Math.min(c|0,b.length));for(var e=a.length;0<e&&0<c;)if(b[--c]!=a[--e])return!1;return 0>=e}},"es6","es3");
$jscomp.polyfill("String.prototype.startsWith",function(a){return a?a:function(a,c){var b=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var e=b.length,f=a.length;c=Math.max(0,Math.min(c|0,b.length));for(var g=0;g<f&&c<e;)if(b[c++]!=a[g++])return!1;return g>=f}},"es6","es3");
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=b[c];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");
$jscomp.polyfill("Array.from",function(a){return a?a:function(a,c,d){c=null!=c?c:function(a){return a};var b=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if("function"==typeof f){a=f.call(a);for(var g=0;!(f=a.next()).done;)b.push(c.call(d,f.value,g++))}else for(f=a.length,g=0;g<f;g++)b.push(c.call(d,a[g],g));return b}},"es6","es3");Math.radians=function(a){return a*Math.PI/180};Math.degrees=function(a){return 180*a/Math.PI};
var clamp=function(a,b,c){return Math.min(Math.max(a,b),c)},THRESHOLD=1E-4,REFRESHRATE=1/65;function rgbToHex(a){var b=parseInt(255*a.r),c=parseInt(255*a.g);a=parseInt(255*a.b);return"#"+(16777216+(b<<16)+(c<<8)+a).toString(16).slice(1)}function hexToRgb(a){a=a.slice(1);a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,c,d,e){return c+c+d+d+e+e});return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(a[1],16)/255,g:parseInt(a[2],16)/255,b:parseInt(a[3],16)/255}:null}
function add_white_color_rgb(a,b){b=void 0===b?.5:b;a="string"==typeof a?a:rgbToHex(a);a=hexToRgb(a);return Object.fromEntries(Object.entries(a).map(function(a){var c=$jscomp.makeIterator(a);a=c.next().value;c=c.next().value;return[a,c*b+(1-b)]}))}function add_white_color_hex(a,b){return rgbToHex(add_white_color_rgb(a,void 0===b?.5:b))}
function add_black_color_rgb(a,b){b=void 0===b?.5:b;a="string"==typeof a?a:rgbToHex(a);a=hexToRgb(a);return Object.fromEntries(Object.entries(a).map(function(a){var c=$jscomp.makeIterator(a);a=c.next().value;c=c.next().value;return[a,c*b]}))}function add_black_color_hex(a,b){return rgbToHex(add_black_color_rgb(a,void 0===b?.5:b))}
var matEdge=new THREE.LineBasicMaterial({color:0,linewidth:1}),matEdge2=new LineMaterial({color:"#000000",linewidth:1,alphaToCoverage:!1}),axisLength=10,axisXObjTemplate=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(axisLength,0,0)]),new THREE.LineBasicMaterial({color:16711680})),axisYObjTemplate=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,axisLength,0)]),new THREE.LineBasicMaterial({color:65280})),
axisZObjTemplate=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,axisLength)]),new THREE.LineBasicMaterial({color:255})),axisTrueNorthObjTemplate=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,axisLength,0)]),new THREE.LineDashedMaterial({color:65280,linewidth:2,dashSize:1.5,gapSize:1}));axisTrueNorthObjTemplate.computeLineDistances();
var axisXObject=null,axisYObject=null,axisZObject=null,axisTrueNorthObject=null,shadowCatcherMat=new THREE.ShadowMaterial;shadowCatcherMat.opacity=.5;
var matGhost=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,blending:THREE.AdditiveBlending}),matDefault={Adiabatic:new THREE.MeshPhongMaterial({color:"#f24b91",side:THREE.DoubleSide,opacity:.8}),Roof:new THREE.MeshPhongMaterial({color:add_black_color_hex("#a82525",.7),side:THREE.DoubleSide,opacity:.85}),OuterWall:new THREE.MeshLambertMaterial({color:"#ffe16b",side:THREE.DoubleSide}),InnerSurf:new THREE.MeshPhongMaterial({color:"#444444",side:THREE.DoubleSide,opacity:.5}),
OuterSurf:new THREE.MeshPhongMaterial({color:"#444444",side:THREE.DoubleSide,opacity:.8}),Window:new THREE.MeshPhongMaterial({color:"#47dcff",side:THREE.DoubleSide,opacity:.3}),Door:new THREE.MeshPhongMaterial({color:"#1747d4",side:THREE.DoubleSide,opacity:.3}),Shading:new THREE.MeshPhongMaterial({color:"#624285",side:THREE.DoubleSide,opacity:.7}),Ground:new THREE.MeshLambertMaterial({color:"#555555",side:THREE.DoubleSide}),Disabled:new THREE.MeshPhongMaterial({color:"#bbbbbb",side:THREE.DoubleSide,
opacity:.3})},mat;for(mat in matDefault)1>matDefault[mat].opacity&&(matDefault[mat].transparent=!0);DEFAULTS={shadingOn:!0,transparencyOn:!0,windowOpacity:.3,debugOn:!1,lineThicknessOn:!1,lineThickness:1,shadowOn:!1,selfShadow:!1,shadowRadius:1,shadowMapSize:1024,shadowOffset:[45,90],sceneObjectKeys:["surfMesh"]};
var idfName="",idfExt="",iddInfoLibrary=null,northAxis=0,boundary=[],bldgRadius=0,bldgCenter=new THREE.Vector3,zoneList=[],constList=[],surfList={},fenList={},shadeList={},sceneObjects=Object.fromEntries(DEFAULTS.sceneObjectKeys.map(function(a){return[a,[]]})),shadowCatcher=null,scene=new THREE.Scene;scene.background=null;var camera=new THREE.PerspectiveCamera(30,canvWidth/canvHeight,.1,1E3);camera.up=new THREE.Vector3(0,0,1);
var lightDirect=new THREE.DirectionalLight(15658734,.6),lightDirectTarget=new THREE.Object3D,lightAmbient=new THREE.AmbientLight(8947848,1),lightShadow=new THREE.DirectionalLight(15658734,0),shadowRadius=DEFAULTS.shadowRadius;lightShadow.shadow.radius=shadowRadius;var shadowOffset=DEFAULTS.shadowOffset,shadowMapSize=DEFAULTS.shadowMapSize;lightShadow.shadow.mapSize.width=shadowMapSize;lightShadow.shadow.mapSize.height=shadowMapSize;
var lightShadowTarget=new THREE.Object3D,DEV=!1,matDev=new THREE.MeshPhongMaterial({color:16776960}),geomDev=new THREE.SphereGeometry(3,8,4),objDev=new THREE.Mesh(geomDev,matDev),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,preserveDrawingBuffer:!0});renderer.setClearColor(16777215,0);renderer.setSize(canvWidth,canvHeight);renderer.domElement.id="CanvasRenderer";document.getElementById("CanvasContainer").appendChild(renderer.domElement);renderer.domElement.style.width="100%";
renderer.domElement.style.height="100%";var CanvasRenderer=renderer.domElement;function exportImage(){console.log("exporting image...");var a=CanvasRenderer.toDataURL("image/png").replace("image/png","image/octet-stream"),b=document.createElement("a");b.setAttribute("href",a);b.setAttribute("download",idfName+".png");document.body.appendChild(b);b.click();b.remove()}
var settingsPanelContent=document.getElementById("SettingsPanelContent"),settingsPanelBlockZones=document.getElementById("SettingsPanelBlockZones"),sttgsShading=document.getElementById("SttgsShading"),sttgsMatTrans=document.getElementById("SttgsMatTrans"),sttgsWinOpac=document.getElementById("SttgsWinOpac"),sttgsLineThkCheckbox=document.getElementById("SttgsLineThkCheckbox"),sttgsLineThkInputfield=document.getElementById("SttgsLineThkInputfield"),sttgsShadow=document.getElementById("SttgsShadow"),
sttgsDebug=document.getElementById("SttgsDebug");function changeZoneAll(a){for(var b=$jscomp.makeIterator(Object.entries(zoneList)),c=b.next();!c.done;c=b.next())c=$jscomp.makeIterator(c.value),c.next(),c.next().value.Visible=a;b=$jscomp.makeIterator(settingsPanelBlockZones.querySelectorAll("input[type=checkbox]"));for(c=b.next();!c.done;c=b.next())c.value.checked=a;updateModel()}function changeZoneVisibility(a){zoneList[a.dataset.zone].Visible=a.checked;updateModel()}var shadingOn=DEFAULTS.shadingOn;
function turnOnShading(a){shadingOn=a;sttgsShading.checked=a;updateModel()}var transparencyOn=DEFAULTS.transparencyOn;function turnOnTransparentMat(a){transparencyOn=a;sttgsMatTrans.checked=a;updateModel()}var windowOpacity=DEFAULTS.windowOpacity;sttgsWinOpac.value=windowOpacity;function updateWindowOpacity(a){isNaN(a)||(windowOpacity=a=clamp(a,0,1));sttgsWinOpac.value=windowOpacity;sttgsWinOpac.blur();matDefault.Window.opacity=windowOpacity;matDefault.Door.opacity=windowOpacity;updateModel()}
function updateWindowOpacityInputfield(a,b){var c=parseFloat(b.value);void 0===a||"Escape"===a.key?(b.value=windowOpacity,b.blur()):!0!==a&&"Enter"!==a.key||updateWindowOpacity(c)}var shadowOn=DEFAULTS.shadowOn,selfShadow=DEFAULTS.selfShadow;function turnOnShadow(a){shadowOn=a;sttgsShadow.checked=a;renderer.shadowMap.enabled=a;lightShadow.castShadow=a;shadowOn&&updateShadowProperties();updateModel()}
function turnOnSelfShadow(a){selfShadow=a;lightShadow.shadow.normalBias=selfShadow?-.1:0;a=$jscomp.makeIterator(sceneObjects.surfMesh);for(var b=a.next();!b.done;b=a.next())b.value.receiveShadow=selfShadow;updateModel()}
function updateShadowProperties(){updateCamera(force=!0,source="updateShadowProperties");lightShadow.shadow.radius=shadowRadius;lightShadow.shadow.mapSize.width=shadowMapSize;lightShadow.shadow.mapSize.height=shadowMapSize;turnOnSelfShadow(selfShadow);lightShadow.shadow.map.dispose();lightShadow.shadow.map=null}var debugOn=DEFAULTS.debugOn;function turnOnDebug(a){debugOn=a;sttgsDebug.checked=a;updateModel()}
var lineThicknessOn=DEFAULTS.lineThicknessOn,lineThickness=DEFAULTS.lineThickness,MAXLINETHICKNESS=5*canvMult,absoluteLineThickness=NaN;function turnOnLineThickness(a){lineThicknessOn=a;sttgsLineThkCheckbox.checked=a;sttgsLineThkInputfield.disabled=!lineThicknessOn;lineThicknessOn?(sttgsLineThkInputfield.value=lineThickness,sttgsLineThkInputfield.type="number",updateAbsoluteLineThickness()):(sttgsLineThkInputfield.type="text",sttgsLineThkInputfield.value="-");updateModel()}
function updateAbsoluteLineThickness(){absoluteLineThickness=lineThickness*bldgRadius/camera.radius*1.4;matEdge2.linewidth=absoluteLineThickness}updateAbsoluteLineThickness();function updateLineThickness(a){isNaN(a)||(lineThickness=a=clamp(a,1,MAXLINETHICKNESS));lineThicknessOn&&(sttgsLineThkInputfield.value=lineThickness,sttgsLineThkInputfield.blur(),updateAbsoluteLineThickness());updateModel()}
function updateLineThicknessInputfield(a,b){var c=parseFloat(b.value);void 0===a||"Escape"===a.key?(b.value=lineThickness,b.blur()):!0!==a&&"Enter"!==a.key||updateLineThickness(c)}
function resetSettings(){turnOnShading(DEFAULTS.shadingOn);turnOnTransparentMat(DEFAULTS.transparencyOn);updateWindowOpacity(DEFAULTS.windowOpacity);turnOnDebug(DEFAULTS.debugOn);turnOnLineThickness(DEFAULTS.lineThicknessOn);updateLineThickness(DEFAULTS.lineThickness);selfShadow=DEFAULTS.selfShadow;shadowRadius=DEFAULTS.shadowRadius;shadowMapSize=DEFAULTS.shadowMapSize;shadowOffset=[].concat($jscomp.arrayFromIterable(DEFAULTS.shadowOffset));turnOnShadow(DEFAULTS.shadowOn)}
function updateModel(){resetScene();renderModel()}function updateSettingsPanel(){settingsPanelContent.scrollTo(0,0);for(var a="",b=$jscomp.makeIterator(Object.entries(zoneList)),c=b.next();!c.done;c=b.next()){c=$jscomp.makeIterator(c.value);var d=c.next().value;c.next();a+='<label><input type="checkbox" data-zone="'+d+'" onclick="changeZoneVisibility(this);" checked> '+d+"</label>"}settingsPanelBlockZones.innerHTML=a}
function polarCoord(a,b){a=Math.radians(a);b=Math.radians(-b-90);return new THREE.Vector3(Math.cos(a)*Math.cos(b),Math.cos(a)*Math.sin(b),Math.sin(a))}var maxZoom=950,lastRendered=Date.now();
function updateCamera(a,b){a=void 0===a?!1:a;b=void 0===b?null:b;camera.alt=clamp(camera.alt,-90,90);camera.radius=clamp(camera.radius,1,maxZoom);lineThicknessOn&&updateAbsoluteLineThickness();camera.azm%=360;var c=camera.azm;camStepped&&(c=45*Math.round(camera.azm/45));camera.position.copy(polarCoord(camera.alt,c).multiplyScalar(camera.radius).add(camera.base));camera.lookAt(camera.base);90==Math.abs(camera.alt)&&(camera.rotation.z=Math.radians(-Math.sign(camera.alt)*c));lightDirect.position.copy(polarCoord(camera.alt,
c+45).add(camera.base));lightDirectTarget.position.copy(camera.base);lightShadow.position.copy(polarCoord(shadowOffset[0],c+shadowOffset[1]).multiplyScalar(camera.radius).add(bldgCenter));objDev.position.copy(polarCoord(45,c+90).multiplyScalar(10).add(camera.base));c=Date.now();if(a||(c-lastRendered)/1E3>REFRESHRATE)lastRendered=c,renderer.render(scene,camera),DEV&&console.log("refreshed - "+(b||"?")+", "+a)}
var clickable=!1,mouseLeft=!1,mouseMiddle=!1,shiftKey=!1,camStepped=!1,camFixed=!1,commandOn=!1,startX=null,startY=null,pressedKeys={};CanvasContainer.ondragstart=function(){return!1};
function customOnMouseMove(a){var b=a.pageX;a=a.pageY;var c=b-startX,d=a-startY;if(mouseLeft)camera.azm+=c/panelWidth*180,camera.alt+=d/panelHeight*180;else if(mouseMiddle){var e=Math.radians(camera.alt),f=-Math.radians(camera.azm+180);c=c/panelWidth*camera.radius/2;d=d/panelWidth*camera.radius/2;e=new THREE.Vector3(Math.cos(f)*c+Math.sin(e)*Math.sin(f)*d,Math.sin(f)*c-Math.sin(e)*Math.cos(f)*d,Math.cos(e)*d);camera.base.add(e)}updateCamera(force=!1,source="customOnMouseMove");startX=b;startY=a}
CanvasContainer.onmousedown=function(a){if(clickable&&"button"!==a.target.tagName.toLowerCase()){startX=a.pageX;startY=a.pageY;0==a.button&&(mouseLeft=!0,mouseMiddle=!1);if(1==a.button||2==a.button)mouseMiddle=!0,mouseLeft=!1;document.addEventListener("mousemove",customOnMouseMove);document.onmouseup=function(a){mouseMiddle=mouseLeft=!1;camStepped&&(camera.azm=45*Math.round(camera.azm/45));document.removeEventListener("mousemove",customOnMouseMove)}}};
document.addEventListener("onmouseleave",function(){document.removeEventListener("mousemove",customOnMouseMove)});CanvasContainer.onwheel=function(a){clickable&&(camera.radius-=a.wheelDeltaY/100*clamp(Math.pow(camera.radius/50,1.2),1,Infinity),updateCamera(force=!0,source="onwheel"))};document.getElementById("PageWrapper").onwheel=function(a){a=a||window.event;if("CanvasRenderer"==a.target.id&&clickable)return!1};
document.getElementById("PageWrapper").onmousedown=function(a){a=a||window.event;if((1==a.button||2==a.button)&&"CanvasRenderer"==a.target.id)return!1};
document.onkeydown=function(a){var b=a.key.toLowerCase(),c=a.code;("/"==b||commandOn)&&a.preventDefault();a.shiftKey&&(shiftKey=!0);mouseLeft&&a.shiftKey&&(camStepped=!0,updateCamera(force=!0,source="onkeydown"));commandOn||"input"==a.target.tagName.toLowerCase()||(""!==idfName&&"KeyS"==c&&exportImage(),"KeyR"==c&&centerCamera(),""!==idfName&&a.ctrlKey&&a.shiftKey&&("KeyC"==c||"KeyV"==c)&&(a.preventDefault(),"KeyC"==c&&panelVisibility(copyPanel,1),"KeyV"==c&&loadSettings()))};var nonCommandKey="Shift Alt Control Enter Escape Tab CapsLock ContextMenu".split(" ");
document.onkeyup=function(a){commandOn&&!a.metaKey&&("ArrowUp"==a.key&&""!=lastCommand&&(commandListener.innerHTML=lastCommand),1==a.key.length&&(commandListener.innerHTML+=a.key.toLowerCase()));switch(a.key){case "Shift":camStepped=shiftKey=!1;updateCamera(force=!0,source="onkeyup(shift)");break;case "/":commandOn||(commandOn=!0,commandListenerVisibility(1));break;case "Enter":commandOn?(commandOn=!1,commandListenerVisibility(0),runCommand(commandListener.innerHTML)):"visible"==copyPanel.style.visibility&&
copySettings();break;case "Escape":panelVisibility(commandPanel,-1);commandOn?(commandOn=!1,commandListenerVisibility(0)):""==idfName?settingsPanelVisibility(-1):settingsPanelVisibility(0);break;case "Backspace":commandOn&&(commandListener.innerHTML=commandListener.innerHTML.slice(0,-1))}};var raycaster=new THREE.Raycaster;raycaster.layers.set(1);
var pointer=new THREE.Vector2,objectDisplay=document.getElementById("objectDisplay"),lastHighlightedObj=null,lastHighlightedObjMat=null,matHighlighted=new THREE.MeshPhongMaterial({color:"#ff0000",side:THREE.DoubleSide,opacity:.7,transparent:!0}),highlightedObjDisplayText="",lastSelectedObj=null,lastSelectedObjMat=null,matSelected=new THREE.MeshPhongMaterial({color:"#ff0000",side:THREE.DoubleSide,opacity:.8,transparent:!0}),selectedObjDisplayText="";
function objectHighlight(a){if(!mouseLeft&&!mouseMiddle){var b=a.target.getBoundingClientRect(),c=a.pageY-b.top;a=2*clamp((a.pageX-b.left)/mainPanelWidth,0,1)-1;c=2*-clamp(c/mainPanelHeight,0,1)+1;pointer.x=a;pointer.y=c;raycaster.setFromCamera(pointer,camera);c=raycaster.intersectObjects(scene.children);if((0<c.length?c[0].object:null)!==lastHighlightedObj){lastHighlightedObj&&(lastHighlightedObj.material=lastHighlightedObjMat,lastSelectedObj&&(lastSelectedObj.material=matSelected));if(0==c.length)objectDisplay.innerHTML=
"",lastHighlightedObj=null;else if(lastHighlightedObj!==c[0].object){lastHighlightedObj=a=c[0].object;lastHighlightedObjMat=a.material.clone();a.material=matHighlighted;c=a.sourceObjName;a=a.sourceObjType;var d="<b>[Name]</b> "+c;switch(a){case "surface":b=surfList[c];void 0!==b.OutsideBCObj&&""!=b.OutsideBCObj&&(d+=" ("+b.OutsideBCObj.toLowerCase()+")");d+="<br><b>[Type]</b> "+a+" ("+b.SurfaceType+")";d+="<br><b>[Construction]</b> "+b.Construction;d+="<br><b>[Zone]</b> "+b.ZoneName;d+="<br>  \u2514\u2500<b>[Surface]</b> "+
c;break;case "fenestration":b=fenList[c];void 0!==b.OutsideBCObj&&""!=b.OutsideBCObj&&(d+=" ("+b.OutsideBCObj.toLowerCase()+")");d+="<br><b>[Type]</b> "+a+" ("+b.SurfaceType+")";d+="<br><b>[Construction]</b> "+b.Construction;d+="<br><b>[Zone]</b> "+surfList[b.SurfaceName].ZoneName;d+="<br>  \u2514\u2500<b>[Surface]</b> "+b.SurfaceName;d+="<br>     \u2514\u2500<b>[Fenestration]</b> "+c;break;case "shading":d+="<br><b>[Type]</b> "+a}d=d.replaceAll(" ","&nbsp;");highlightedObjDisplayText=objectDisplay.innerHTML=
d}updateCamera(force=!0,source="objectHighlight")}}}CanvasRenderer.addEventListener("pointerleave",function(){null!==lastHighlightedObj&&(lastHighlightedObj.material=lastHighlightedObjMat,updateCamera(force=!0,source="pointerleave"));objectDisplay.innerHTML=""});
function resetBldgInfo(){northAxis=0;boundary=[[Infinity,Infinity,Infinity],[-Infinity,-Infinity,-Infinity]];bldgRadius=0;bldgCenter=new THREE.Vector3;zoneList={};constList=[];surfList={};fenList={};shadeList={};sceneObjects=Object.fromEntries(DEFAULTS.sceneObjectKeys.map(function(a){return[a,[]]}));shadowCatcher=null}function resetCamera(){camera.base=new THREE.Vector3(0,0,0);camera.alt=20;camera.azm=-30;camera.radius=10;updateCamera(force=!0,source="resetCamera")}resetCamera();
function centerCamera(){resetCamera();camera.base.copy(bldgCenter);camera.radius=1.5*bldgRadius;updateCamera(force=!0,source="centerCamera")}
function resetScene(){scene.remove.apply(scene,scene.children);sceneObjects=Object.fromEntries(DEFAULTS.sceneObjectKeys.map(function(a){return[a,[]]}));scene.add(lightDirect);scene.add(lightDirectTarget);lightDirect.target=lightDirectTarget;scene.add(lightAmbient);scene.add(lightShadow);scene.add(lightShadowTarget);lightShadow.target=lightShadowTarget;DEV&&scene.add(objDev)}resetScene();
function triangulateSurfacefromFlatVertlist(a,b){b=void 0===b?null:b;var c=[];earcut(a.flat(),b,3).forEach(function(b){c.push(a[b])});return c}
function triangulatedSurfacefromVertlist(a,b){b=void 0===b?null:b;new THREE.Vector3(1,0,0);var c=new THREE.Vector3(0,0,1),d=new THREE.Vector3,e=new (Function.prototype.bind.apply(THREE.Vector3,[null].concat($jscomp.arrayFromIterable(a[0])))),f=new (Function.prototype.bind.apply(THREE.Vector3,[null].concat($jscomp.arrayFromIterable(a[1]))));f=(new THREE.Vector3).subVectors(f,e);for(var g=2;g<a.length&&!(d=new (Function.prototype.bind.apply(THREE.Vector3,[null].concat($jscomp.arrayFromIterable(a[g])))),
d=(new THREE.Vector3).subVectors(d,e),d=(new THREE.Vector3).crossVectors(d,f),d.length()>THRESHOLD);g++);e=new THREE.BufferGeometry;d.normalize();if((new THREE.Vector3).crossVectors(d,c).length()<THRESHOLD)a=new Float32Array(triangulateSurfacefromFlatVertlist(a,b).flat()),e.setAttribute("position",new THREE.BufferAttribute(a,3));else{var p=new THREE.Quaternion;p.setFromUnitVectors(d,c);var u=[];a.forEach(function(a){a=new (Function.prototype.bind.apply(THREE.Vector3,[null].concat($jscomp.arrayFromIterable(a))));
a.applyQuaternion(p);u.push([a.x,a.y,a.z])});a=new Float32Array(triangulateSurfacefromFlatVertlist(u,b).flat());e.setAttribute("position",new THREE.BufferAttribute(a,3));p.invert();e.applyQuaternion(p)}e.computeVertexNormals();return e}function loadExampleFile(){idfName=exampleIDFName;idfExt=exampleIDFExt;loadFile(exampleIDFCode)}window.onload=loadExampleFile;
function readFile(a){if(0<a.length){a=a[0];if(a.name.endsWith(".idf"))idfName=a.name.slice(0,-4),idfExt=".idf";else if(a.name.endsWith(".expidf"))idfName=a.name.slice(0,-7),idfExt=".expidf";else{window.alert("Only .idf, .expidf formats supported!");return}reader.readAsText(a,"utf-8")}}
function loadFile(a){CanvasRenderer.removeEventListener("pointermove",objectHighlight);settingsPanelVisibility(0);panelVisibilityAll(-1);camFixed||resetSettings();lastHighlightedObjMat=lastHighlightedObj=null;resetBldgInfo();parseIDF(a);fileSelectorTag.innerHTML=""==idfName?"":idfName+idfExt;addModel();updateSettingsPanel();CanvasRenderer.addEventListener("pointermove",objectHighlight)}var reader=new FileReader;reader.onload=function(){loadFile(reader.result)};
var fileSelector=document.getElementById("fileSelector"),fileSelectorTag=document.getElementById("fileSelectorTag");fileSelector.addEventListener("change",function(a){readFile(a.target.files)});document.body.addEventListener("drop",function(a){a.stopPropagation();a.preventDefault();clickable=!0;fileHoverMask.style.display="none";fileHover.style.display="none";readFile(a.dataTransfer.files)});
var fileHoverMask=document.getElementById("fileHoverMask"),fileHover=document.getElementById("fileHover"),fileHoverText=document.getElementById("fileHoverText");
document.body.addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy";clickable=!1;fileHoverMask.style.display="block";fileHover.style.display="block";a.shiftKey?(camFixed=!0,fileHoverText.style.textShadow="#fff 0 0 10px, #ffe880 0 0 20px, #000 0 0 30px"):(camFixed=!1,fileHoverText.style.textShadow="#fff 0 0 10px, #80daff 0 0 20px, #000 0 0 30px")});
fileHoverMask.addEventListener("dragleave",function(a){camFixed=!1;clickable=!0;fileHoverMask.style.display="none";fileHover.style.display="none"});
function parseIDF(a){if(0>=a.length)return-1;a=a.replace(/!.*\s*/g,"");a=a.replace(/,\s*/g,",").replace(/;\s*/g,";").trim();a=a.split(";");iddInfoLibrary=null;for(var b="",c=0;c<a.length;c++){var d=a[c];if(d.toLowerCase().startsWith("version")){b=d.split(",")[1].split(".");c=[parseInt(b[0]),parseInt(b[1])];b=c[0]+"_"+c[1]+"_0";b in versionLibrary||(b=7>=c[0]?"7_2_0":Object.keys(versionLibrary)[Object.keys(versionLibrary).length-1]);console.log(b+".idd used.");break}}iddInfoLibrary=versionLibrary[b];
console.log(iddInfoLibrary);for(b=0;b<a.length;b++)if(c=a[b],c.toLowerCase().startsWith("building")){northAxis=parseFloat(c.split(",")[2]);break}a.forEach(function(a){if(a.toLowerCase().startsWith("zone")||a.toLowerCase().startsWith("construction")){a=a.split(",");var b=a[1];switch(a[0].toLowerCase()){case "zone":var c=iddInfoLibrary.zone;b in zoneList||(zoneList[b]={Surfaces:[],Origin:[Number(a[c.indexOf("x origin")]),Number(a[c.indexOf("y origin")]),Number(a[c.indexOf("z origin")])],NDirection:[],
Visible:!0});break;case "construction":constList.push(b)}}});var e=!1;a.forEach(function(a){if(a.toLowerCase().startsWith("wall,")||a.toLowerCase().startsWith("wall:")||a.toLowerCase().startsWith("window,")||a.toLowerCase().startsWith("window:"))e||(e=!0,idfName="",settingsPanelVisibility(-1),window.alert('Currently only supports idf files using "BuildingSurface:Detailed".'));else if(a.toLowerCase().startsWith("buildingsurface:detailed")||a.toLowerCase().startsWith("fenestrationsurface:detailed")||
a.toLowerCase().startsWith("shading:building:detailed")){a=a.split(",");var b=a[1].toLowerCase();switch(a[0].toLowerCase()){case "buildingsurface:detailed":for(var c=iddInfoLibrary["buildingsurface:detailed"],d=a[c.indexOf("zone name")],f=zoneList[d].Origin,k=c.indexOf("vertex 1 x-coordinate"),r=parseInt((a.length-k)/3),q=[],m=-Infinity,n=0;n<r;n++){for(var l=[],h=0;3>h;h++){var t=f[h]+Number(a[k+3*n+h]);t<boundary[0][h]&&(boundary[0][h]=t);t>boundary[1][h]&&(boundary[1][h]=t);l.push(t);2==h&&m<t&&
(m=t)}q.push(l)}f=[];b in surfList&&(f=surfList[b].Fenestrations);surfList[b]={SurfaceType:a[c.indexOf("surface type")].toLowerCase(),Construction:a[c.indexOf("construction name")],ZoneName:d,OutsideBC:a[c.indexOf("outside boundary condition")].toLowerCase(),OutsideBCObj:a[c.indexOf("outside boundary condition object")],VerticeNumber:r,Vertices:q,Fenestrations:f,MaximumZ:m};zoneList[d].Surfaces.push(b);break;case "fenestrationsurface:detailed":c=iddInfoLibrary["fenestrationsurface:detailed"];d=a[c.indexOf("building surface name")].toLowerCase();
r=zoneList[surfList[d].ZoneName].Origin;q=c.indexOf("vertex 1 x-coordinate");m=parseInt((a.length-q)/3);f=[];for(k=0;k<m;k++){n=[];for(l=0;3>l;l++)h=r[l]+Number(a[q+3*k+l]),h<boundary[0][l]&&(boundary[0][l]=h),h>boundary[1][l]&&(boundary[1][l]=h),n.push(h);f.push(n)}fenList[b]={SurfaceType:a[c.indexOf("surface type")].toLowerCase(),Construction:a[c.indexOf("construction name")],SurfaceName:d,OutsideBCObj:a[c.indexOf("outside boundary condition object")],VerticeNumber:m,Vertices:f};d in surfList?surfList[d].Fenestrations.push(b):
surfList[d]={Fenestrations:[b]};break;case "shading:building:detailed":c=iddInfoLibrary["shading:building:detailed"].indexOf("vertex 1 x-coordinate");d=parseInt((a.length-c)/3);r=[];q=-Infinity;for(m=0;m<d;m++){f=[];for(k=0;3>k;k++)n=Number(a[c+3*m+k]),f.push(n),2==k&&q<n&&(q=n);r.push(f)}shadeList[b]={VerticeNumber:d,Vertices:r}}}});a=[];for(c=b=0;3>c;c++)a.push((boundary[0][c]+boundary[1][c])/2),b+=Math.pow(boundary[1][c]-boundary[0][c],2);bldgRadius=Math.sqrt(b);bldgCenter=new (Function.prototype.bind.apply(THREE.Vector3,
[null].concat($jscomp.arrayFromIterable(a))));lightShadowTarget.position.copy(bldgCenter);console.log(constList);console.log(surfList);console.log(fenList);console.log("Done!")}
function addModel(){resetScene();camFixed||centerCamera();var a=boundary[1][0]-boundary[0][0],b=boundary[1][1]-boundary[0][1],c=Math.max(a,b),d=new THREE.BufferGeometry;a=new Float32Array([boundary[0][0]-a,boundary[0][1]-b,-.01,boundary[1][0]+a,boundary[0][1]-b,-.01,boundary[1][0]+a,boundary[1][1]+b,-.01,boundary[0][0]-a,boundary[0][1]-b,-.01,boundary[1][0]+a,boundary[1][1]+b,-.01,boundary[0][0]-a,boundary[1][1]+b,-.01]);d.setAttribute("position",new THREE.BufferAttribute(a,3));d.computeVertexNormals();
shadowCatcher=new THREE.Mesh(d,shadowCatcherMat);shadowCatcher.receiveShadow=!0;shadowCatcher.renderOrder=2;shadowCatcher.position.z=0;lightShadow.shadow.camera=new THREE.OrthographicCamera(-c,c,c,-c,.5,1E3);c=new THREE.Vector3(boundary[0][0]-.1*bldgRadius,boundary[0][1]-.1*bldgRadius,0);axisXObject=axisXObjTemplate.clone();axisXObject.translateX(c.x);axisXObject.translateY(c.y);axisYObject=axisYObjTemplate.clone();axisYObject.translateX(c.x);axisYObject.translateY(c.y);axisZObject=axisZObjTemplate.clone();
axisZObject.translateX(c.x);axisZObject.translateY(c.y);axisTrueNorthObject=axisTrueNorthObjTemplate.clone();axisTrueNorthObject.translateX(c.x);axisTrueNorthObject.translateY(c.y);axisTrueNorthObject.rotateZ(Math.radians(northAxis));c={};d=$jscomp.makeIterator(Object.entries(surfList));for(a=d.next();!a.done;c={$jscomp$loop$prop$holes$48:c.$jscomp$loop$prop$holes$48,$jscomp$loop$prop$vertList$49:c.$jscomp$loop$prop$vertList$49,$jscomp$loop$prop$points$50:c.$jscomp$loop$prop$points$50,$jscomp$loop$prop$positions$51:c.$jscomp$loop$prop$positions$51},
a=d.next()){b=$jscomp.makeIterator(a.value);a=b.next().value;b=b.next().value;c.$jscomp$loop$prop$vertList$49=b.Vertices;c.$jscomp$loop$prop$holes$48=null;0<b.Fenestrations.length&&(c.$jscomp$loop$prop$holes$48=[],b.Fenestrations.forEach(function(a){return function(b){b=fenList[b];a.$jscomp$loop$prop$holes$48.push(a.$jscomp$loop$prop$vertList$49.length);a.$jscomp$loop$prop$vertList$49=a.$jscomp$loop$prop$vertList$49.concat(b.Vertices)}}(c)));var e=triangulatedSurfacefromVertlist(c.$jscomp$loop$prop$vertList$49,
c.$jscomp$loop$prop$holes$48);surfList[a].Geometries=e;c.$jscomp$loop$prop$points$50=[];c.$jscomp$loop$prop$positions$51=[];b.Vertices.forEach(function(a){return function(b){a.$jscomp$loop$prop$points$50.push(new THREE.Vector3(b[0],b[1],b[2]));a.$jscomp$loop$prop$positions$51.push.apply(a.$jscomp$loop$prop$positions$51,$jscomp.arrayFromIterable(b))}}(c));c.$jscomp$loop$prop$points$50.push(c.$jscomp$loop$prop$points$50[0]);c.$jscomp$loop$prop$positions$51.push(c.$jscomp$loop$prop$positions$51[0],c.$jscomp$loop$prop$positions$51[1],
c.$jscomp$loop$prop$positions$51[2]);e=(new THREE.BufferGeometry).setFromPoints(c.$jscomp$loop$prop$points$50);surfList[a].EdgeObjects=new THREE.Line(e,matEdge);e=new LineGeometry;e.setPositions(c.$jscomp$loop$prop$positions$51);surfList[a].EdgeObjects2=new Line2(e,matEdge2);surfList[a].EdgeObjects2.renderOrder=0;b=triangulatedSurfacefromVertlist(b.Vertices);b=new THREE.Mesh(b,matGhost);b.castShadow=!0;b.material.colorWrite=!1;b.renderOrder=Infinity;surfList[a].ShadowObjects=b}c={};d=$jscomp.makeIterator(Object.entries(fenList));
for(a=d.next();!a.done;c={$jscomp$loop$prop$points$37$53:c.$jscomp$loop$prop$points$37$53,$jscomp$loop$prop$positions$38$54:c.$jscomp$loop$prop$positions$38$54},a=d.next())b=$jscomp.makeIterator(a.value),a=b.next().value,b=b.next().value,e=triangulatedSurfacefromVertlist(b.Vertices),e.computeVertexNormals(),fenList[a].Geometries=e,c.$jscomp$loop$prop$points$37$53=[],c.$jscomp$loop$prop$positions$38$54=[],b.Vertices.forEach(function(a){return function(b){a.$jscomp$loop$prop$points$37$53.push(new THREE.Vector3(b[0],
b[1],b[2]));a.$jscomp$loop$prop$positions$38$54.push.apply(a.$jscomp$loop$prop$positions$38$54,$jscomp.arrayFromIterable(b))}}(c)),c.$jscomp$loop$prop$points$37$53.push(c.$jscomp$loop$prop$points$37$53[0]),c.$jscomp$loop$prop$positions$38$54.push(c.$jscomp$loop$prop$positions$38$54[0],c.$jscomp$loop$prop$positions$38$54[1],c.$jscomp$loop$prop$positions$38$54[2]),b=(new THREE.BufferGeometry).setFromPoints(c.$jscomp$loop$prop$points$37$53),fenList[a].EdgeObjects=new THREE.Line(b,matEdge),b=new LineGeometry,
b.setPositions(c.$jscomp$loop$prop$positions$38$54),fenList[a].EdgeObjects2=new Line2(b,matEdge2),fenList[a].EdgeObjects2.renderOrder=0;c={};d=$jscomp.makeIterator(Object.entries(shadeList));for(a=d.next();!a.done;c={$jscomp$loop$prop$points$41$56:c.$jscomp$loop$prop$points$41$56},a=d.next())b=$jscomp.makeIterator(a.value),a=b.next().value,b=b.next().value,e=triangulatedSurfacefromVertlist(b.Vertices),e.computeVertexNormals(),shadeList[a].Geometries=e,c.$jscomp$loop$prop$points$41$56=[],b.Vertices.forEach(function(a){return function(b){a.$jscomp$loop$prop$points$41$56.push(new THREE.Vector3(b[0],
b[1],b[2]))}}(c)),c.$jscomp$loop$prop$points$41$56.push(c.$jscomp$loop$prop$points$41$56[0]),e=(new THREE.BufferGeometry).setFromPoints(c.$jscomp$loop$prop$points$41$56),shadeList[a].EdgeObjects=new THREE.Line(e,matEdge),b=triangulatedSurfacefromVertlist(b.Vertices),b=new THREE.Mesh(b,matGhost),b.castShadow=!0,b.material.colorWrite=!1,b.renderOrder=Infinity,shadeList[a].ShadowObjects=b;renderModel()}
function renderModel(){shadowOn&&scene.add(shadowCatcher);for(var a=[],b=$jscomp.makeIterator(Object.entries(surfList)),c=b.next();!c.done;c=b.next()){var d=$jscomp.makeIterator(c.value);c=d.next().value;d=d.next().value;if(!a.includes(c)){var e=d.ZoneName,f=d.Geometries,g=matDefault.InnerSurf;switch(d.OutsideBC){case "outdoors":switch(d.SurfaceType){case "wall":g=matDefault.OuterWall;break;case "roof":g=matDefault.Roof;break;case "floor":g=matDefault.OuterSurf}break;case "adiabatic":g=matDefault.Adiabatic;
break;case "ground":g=matDefault.Ground}c.toLowerCase()==d.OutsideBCObj.toLowerCase()&&(g=matDefault.Adiabatic);g=g.clone();if("surface"==d.OutsideBC&&""!=d.OutsideBCObj){var p=d.OutsideBCObj.toLowerCase(),u=surfList[p].ZoneName;if(zoneList[e].Visible)a.push(p);else if(zoneList[u].Visible){a.push(c);continue}else a.push(p)}zoneList[e].Visible?(transparencyOn||(1>g.opacity&&(g.color=add_white_color_rgb(add_black_color_hex(g.color,g.opacity),1-(1-g.opacity)/2.5),g.opacity=1),g.transparent=!1),e=new THREE.Mesh(f,
g),e.renderOrder=1,e.layers.enable(1),e.sourceObjName=c,e.sourceObjType="surface",selfShadow&&(e.receiveShadow=!0),scene.add(e),sceneObjects.surfMesh.push(e),lineThicknessOn&&["outdoors","ground"].includes(d.OutsideBC)?scene.add(d.EdgeObjects2):scene.add(d.EdgeObjects),shadowOn&&null!=d.ShadowObjects&&scene.add(d.ShadowObjects)):(c=new THREE.Mesh(f,matDefault.Disabled),c.renderOrder=3,c.layers.enable(2),scene.add(c))}}a=[];b=$jscomp.makeIterator(Object.entries(fenList));for(c=b.next();!c.done;c=b.next())if(d=
$jscomp.makeIterator(c.value),c=d.next().value,d=d.next().value,!a.includes(c)&&(e=surfList[d.SurfaceName],zoneList[e.ZoneName].Visible)){""!=d.OutsideBCObj&&a.push(d.OutsideBCObj.toLowerCase());f=d.Geometries;g=matDefault.Window;switch(d.SurfaceType){case "door":g=matDefault.Door;break;case "glassdoor":g=matDefault.Door}g=g.clone();g.color=add_white_color_rgb(add_black_color_hex(g.color,clamp(1.3-windowOpacity,0,1)),1-clamp(windowOpacity-.3,0,1)/2.5);f=new THREE.Mesh(f,g);f.renderOrder=1;f.layers.enable(1);
f.sourceObjName=c;f.sourceObjType="fenestration";scene.add(f);lineThicknessOn&&["outdoors","ground"].includes(e.OutsideBC)?scene.add(d.EdgeObjects2):scene.add(d.EdgeObjects)}a=$jscomp.makeIterator(Object.entries(shadeList));for(b=a.next();!b.done;b=a.next())c=$jscomp.makeIterator(b.value),b=c.next().value,c=c.next().value,d=c.Geometries,e=matDefault.Shading.clone(),shadingOn?(transparencyOn||(1>e.opacity&&(e.color=add_white_color_rgb(add_black_color_hex(e.color,e.opacity),1-(1-e.opacity)/2.2),e.opacity=
1),e.transparent=!1),d=new THREE.Mesh(d,e),d.layers.enable(1),d.sourceObjName=b,d.sourceObjType="shading",scene.add(d),scene.add(c.EdgeObjects),shadowOn&&scene.add(c.ShadowObjects)):(b=new THREE.Mesh(d,matDefault.Disabled),b.renderOrder=3,b.layers.enable(2),scene.add(b));debugOn&&(scene.add(axisXObject),scene.add(axisYObject),scene.add(axisZObject),scene.add(axisTrueNorthObject));updateCamera(force=!0,source="renderModel")}
function changeBackgroundColor(a,b){a=void 0===a?-1:a;b=void 0===b?null:b;Array.from(document.getElementsByClassName("changeBackgroundColorBtn")).forEach(function(a){a.classList.remove("changeBgColorBtnHighlighted");a.disabled=!1});b.classList.add("changeBgColorBtnHighlighted");b.disabled=!0;switch(a){case -1:CanvasContainer.style.backgroundColor="";objectDisplay.className="transparentmode";console.log('Background changed to "transparent"');break;case 0:CanvasContainer.style.backgroundColor="black";
objectDisplay.className="blackmode";console.log('Background changed to "black"');break;case 1:CanvasContainer.style.backgroundColor="white",objectDisplay.className="whitemode",console.log('Background changed to "white"')}}var commandListener=document.getElementById("CommandListener");commandListenerVisibility(0);
function commandListenerVisibility(a){switch(void 0===a?0:a){case 0:commandListener.style.visibility="hidden";commandListener.style.opacity=0;commandListener.classList.remove("fadein");commandListener.classList.add("fadeout");break;case 1:commandListener.innerHTML="",commandListener.style.visibility="visible",commandListener.style.opacity=1,commandListener.classList.remove("fadeout"),commandListener.classList.add("fadein"),commandListener.classList.remove("CommandFail"),commandListener.classList.remove("CommandSuccess")}}
var lastCommand="";
function runCommand(a){lastCommand=a=void 0===a?"":a;commandListener.classList.add("CommandSuccess");switch(a){case "test":console.log("TEST!");break;case "help":panelVisibility(commandPanel,1);break;default:if(a.includes(" ")){var b=a.match(/(\S+)\s+(\S+)/);a=b[1];b=b[2];lastCommand=a;switch(a){case "test":console.log("TEST! -",b);break;case "camerafar":b=parseFloat(b);1E3>b&&(b=1E3);camera.far=b;camera.updateProjectionMatrix();updateCamera(force=!0,source="runCommand");break;case "maxzoom":b=parseFloat(b);
950>b&&(b=950);maxZoom=b;camera.far=b+50;camera.updateProjectionMatrix();updateCamera(force=!0,source="runCommand");break;case "shadowalt":b=parseFloat(b);shadowOffset[0]=b;updateCamera(force=!0,source="runCommand");break;case "shadowazm":b=parseFloat(b);shadowOffset[1]=b;updateCamera(force=!0,source="runCommand");break;case "shadowmapsize":shadowMapSize=parseInt(b);shadowOn&&updateShadowProperties();updateCamera(force=!0,source="runCommand");break;case "shadowradius":shadowRadius=parseFloat(b);shadowOn&&
updateShadowProperties();updateCamera(force=!0,source="runCommand");break;case "shadowheight":b=parseFloat(b);shadowCatcher.translateZ(b-shadowCatcher.position.z);updateCamera(force=!0,source="runCommand");break;case "selfshadow":selfShadow="on"==b?!0:!1;updateShadowProperties();break;default:lastCommand="",commandListener.classList.remove("CommandSuccess"),commandListener.classList.add("CommandFail")}}else lastCommand="",commandListener.classList.remove("CommandSuccess"),commandListener.classList.add("CommandFail")}}
function toggleCopyCheckboxes(a,b){a=$jscomp.makeIterator(a.querySelectorAll("label"));for(var c=a.next();!c.done;c=a.next())c.value.querySelector("input").checked=b}
function settingsCode(a,b){switch(a){case "sh":if(b)turnOnShading("1"==b);else return shadingOn?"1":"0";break;case "mt":if(b)turnOnTransparentMat("1"==b);else return transparencyOn?"1":"0";break;case "wo":if(b)updateWindowOpacity(parseFloat(b));else return String(windowOpacity);break;case "et":if(b)a=parseFloat(b),turnOnLineThickness(0<a),updateLineThickness(Math.abs(a));else return String(lineThickness*(lineThicknessOn?1:-1));break;case "st":if(b)turnOnShadow("1"==b);else return shadowOn?"1":"0";
break;case "ss":if(b)a=b.split("/"),shadowOffset[0]=parseFloat(a[0]),shadowOffset[1]=parseFloat(a[1]),shadowMapSize=parseInt(a[2]),shadowRadius=parseFloat(a[3]),shadowCatcher.translateZ(parseFloat(a[4])-shadowCatcher.position.z),selfShadow="1"==a[5],updateShadowProperties();else return[shadowOffset[0],shadowOffset[1],shadowMapSize,lightShadow.shadow.radius,shadowCatcher.position.z,selfShadow?"1":"0"].join("/");break;case "dg":if(b)turnOnDebug("1"==b);else return debugOn?"1":"0";break;case "cp":if(b)a=
b.split("/").map(Number),camera.base=new (Function.prototype.bind.apply(THREE.Vector3,[null].concat($jscomp.arrayFromIterable(a))));else return camera.base.x+"/"+camera.base.y+"/"+camera.base.z;break;case "ca":if(b)camera.alt=parseFloat(b);else return String(camera.alt);break;case "cz":if(b)camera.azm=parseFloat(b);else return String(camera.azm);break;case "cr":if(b)camera.radius=parseFloat(b);else return String(camera.radius);break;default:console.error('"'+b+'" is not a valid tag!')}}
function copySettings(){for(var a="##EPPrevSttgs##;",b=$jscomp.makeIterator(copyPanel.querySelectorAll("input")),c=b.next();!c.done;c=b.next()){c=c.value.dataset.tag;var d=settingsCode(c);a+=c+":"+d+";"}panelVisibility(copyPanel,-1);navigator.clipboard.writeText(a);console.log("Settings copied!")}
function loadSettings(){navigator.clipboard.readText().then(function(a){if(a.startsWith("##EPPrevSttgs##;")){a=$jscomp.makeIterator(a.split(";"));for(var b=a.next();!b.done;b=a.next())if(b=b.value,"##EPPrevSttgs##"!=b&&""!=b){var c=$jscomp.makeIterator(b.split(":"));b=c.next().value;c=c.next().value;settingsCode(b,c)}updateModel();panelVisibilityAll(-1);console.log("Settings pasted!")}}).catch(function(a){console.error("Failed to read clipboard contents: ",a)})};
